<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پلیر آنلاین ویدئو با زیرنویس - افزودن در حین پخش</title>
    
    <!-- کتابخانه Plyr برای پلیر ویدئو (CSS) -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

    <style>
        /* CSS شما بدون تغییر باقی مانده است */
        :root {
            --sub-text-color: #FFFFFF;
            --sub-bg-color: rgba(0, 0, 0, 0.7);
            --sub-direction: rtl;
            --sub-font-size: 22px;
            --plyr-color-main: #4dabf7;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            direction: rtl;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
            background-color: #2c2c2c;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
        }
        h1, h2 {
            text-align: center;
            color: #ffffff;
            font-weight: 600;
        }
        h1 { font-size: 2rem; margin-bottom: 10px; }
        h2 {
            font-size: 1.5rem;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }
        p {
            text-align: center;
            color: #a0a0a0;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }
        .input-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }
        .input-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #c0c0c0;
            display: block;
        }
        input[type="url"], select {
            width: 100%;
            padding: 12px;
            background-color: #3b3b3b;
            border: 1px solid #555;
            color: #e0e0e0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="url"]:focus, select:focus {
            outline: none;
            border-color: var(--plyr-color-main);
            box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.3);
        }
        .custom-file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .custom-file-upload input[type="file"] { display: none; }
        .custom-file-upload .file-label {
            display: block;
            padding: 12px;
            background-color: #3b3b3b;
            border: 1px solid #555;
            border-radius: 8px;
            cursor: pointer;
            text-align: right;
            transition: background-color 0.3s;
        }
        .custom-file-upload .file-label:hover { background-color: #4a4a4a; }
        #file-name {
            color: #a0a0a0;
            margin-right: 10px;
            font-size: 0.9rem;
        }
        #load-button {
            padding: 14px 20px;
            background: linear-gradient(90deg, #4dabf7, #2a6db5);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }
        #load-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(77, 171, 247, 0.2);
        }
        #player-container {
            width: 100%;
            margin-bottom: 30px;
        }
        .plyr {
            border-radius: 8px;
            overflow: hidden;
        }
        .plyr .plyr__captions {
            font-size: var(--sub-font-size) !important;
            direction: var(--sub-direction) !important;
            color: var(--sub-text-color) !important;
        }
        .plyr .plyr__captions .plyr__caption span {
            background-color: var(--sub-bg-color) !important;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            line-height: 1.5;
            white-space: pre-wrap;
            box-shadow: none;
        }
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        .control-group label, .control-group-full label {
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #c0c0c0;
        }
        .control-group-full { grid-column: 1 / -1; }
        #font-size-value {
            font-weight: bold;
            color: #fff;
        }
        .font-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #555;
            outline: none;
            border-radius: 4px;
            transition: opacity .2s;
            margin-top: 5px;
        }
        .font-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--plyr-color-main);
            cursor: pointer;
            border-radius: 50%;
        }
        .font-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--plyr-color-main);
            cursor: pointer;
            border-radius: 50%;
        }
        /* اضافه شده: پیام وضعیت */
        .status-message {
            text-align: center;
            padding: 10px;
            margin-top: 10px;
            border-radius: 6px;
            font-weight: 500;
            display: none;
        }
        .status-success {
            background-color: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        .status-error {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>پلیر آنلاین ویدئو</h1>
        <p>لینک مستقیم ویدئو و فایل زیرنویس خود را وارد کنید و آنلاین تماشا کنید.</p>
        
        <div class="input-section">
            <div class="input-group">
                <label for="video-url">لینک ویدئو (mp4, mkv, ...)</label>
                <input type="url" id="video-url" placeholder="https://example.com/video.mp4">
            </div>
            <div class="input-group">
                 <label for="subtitle-file">فایل زیرنویس (SRT)</label>
                 <div class="custom-file-upload">
                    <input type="file" id="subtitle-file" accept=".srt">
                    <label for="subtitle-file" class="file-label">
                        انتخاب فایل...
                        <span id="file-name">هیچ فایلی انتخاب نشده</span>
                    </label>
                </div>
            </div>
            <button id="load-button">پخش</button>
            <div id="status-message" class="status-message"></div>
        </div>

        <!-- *** تغییر کلیدی: ساختار پلیر مانند کد اول شد و placeholder حذف گردید *** -->
        <div id="player-container">
            <video id="player" playsinline controls>
                <!-- ترک زیرنویس به صورت پویا اضافه خواهد شد -->
            </video>
        </div>

        <h2>تنظیمات زیرنویس</h2>
        <div class="controls-grid">
             <div class="control-group-full">
                <label for="font-size-slider">اندازه فونت: <span id="font-size-value">22</span>px</label>
                <input type="range" id="font-size-slider" class="font-slider" min="14" max="40" value="22">
            </div>
            <div class="control-group">
                <label for="direction-select">جهت متن</label>
                <select id="direction-select">
                    <option value="rtl" selected>راست به چپ</option>
                    <option value="ltr">چپ به راست</option>
                </select>
            </div>
            <div class="control-group">
                <label for="text-color-select">رنگ متن</label>
                <select id="text-color-select">
                    <option value="#FFFFFF" selected>سفید</option>
                    <option value="#ffc107">نارنجی</option>
                    <option value="#000000">مشکی</option>
                    <option value="#4dabf7">آبی</option>
                </select>
            </div>
            <div class="control-group">
                <label for="bg-color-select">رنگ پس‌زمینه</label>
                <select id="bg-color-select">
                    <option value="rgba(0, 0, 0, 0.7)" selected>مشکی</option>
                    <option value="rgba(255, 255, 255, 0.5)">سفید</option>
                    <option value="transparent">بدون رنگ</option>
                </select>
            </div>
        </div>
    </div>

    <!-- کتابخانه Plyr برای پلیر ویدئو (JavaScript) -->
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- انتخاب عناصر DOM ---
            const videoUrlInput = document.getElementById('video-url');
            const subtitleFileInput = document.getElementById('subtitle-file');
            const loadButton = document.getElementById('load-button');
            const playerElement = document.getElementById('player');
            const fileNameSpan = document.getElementById('file-name');
            const fontSizeSlider = document.getElementById('font-size-slider');
            const fontSizeValueSpan = document.getElementById('font-size-value');
            const directionSelect = document.getElementById('direction-select');
            const textColorSelect = document.getElementById('text-color-select');
            const bgColorSelect = document.getElementById('bg-color-select');
            const statusMessage = document.getElementById('status-message');
            
            let subtitleObjectURL = null;

            // --- تابع نمایش پیام وضعیت ---
            function showStatus(message, isSuccess = true) {
                statusMessage.textContent = message;
                statusMessage.className = isSuccess ? 'status-message status-success' : 'status-message status-error';
                statusMessage.style.display = 'block';
                
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }

            // --- تابع تبدیل SRT به VTT ---
            function srtToVtt(srtText) {
                return "WEBVTT\n\n" + srtText
                    .replace(/\r\n/g, '\n')
                    .replace(/\n{3,}/g, '\n\n')
                    .replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g, "$1.$2");
            }

            // *** تغییر کلیدی: پلیر بلافاصله بعد از بارگذاری صفحه ساخته می‌شود ***
            const player = new Plyr(playerElement, {
                i18n: {
                    restart: 'شروع مجدد', rewind: '{seektime} ثانیه به عقب', play: 'پخش', pause: 'مکث',
                    fastForward: '{seektime} ثانیه به جلو', seek: 'جابجایی', seekLabel: '{currentTime} از {duration}',
                    played: 'پخش شده', buffered: 'بافر شده', currentTime: 'زمان فعلی', duration: 'مدت زمان',
                    volume: 'تنظیم صدا', mute: 'بی‌صدا', unmute: 'باصدا', enableCaptions: 'فعال‌کردن زیرنویس',
                    disableCaptions: 'غیرفعال‌کردن زیرنویس', download: 'دانلود', enterFullscreen: 'بزرگنمایی',
                    exitFullscreen: 'خروج از بزرگنمایی', settings: 'تنظیمات', captions: 'زیرنویس', quality: 'کیفیت',
                    speed: 'سرعت پخش', normal: 'عادی', pip: 'تصویر در تصویر'
                },
                captions: { active: true, update: true, language: 'fa' },
                keyboard: { focused: true, global: true },
                controls: [
                    'play-large', 'restart', 'rewind', 'play', 'fast-forward', 'progress', 'current-time',
                    'duration', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                ],
                settings: ['captions', 'quality', 'speed'],
                speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 1.75, 2] },
                ratio: '16:9' // تنظیم نسبت ابعاد ویدیو
            });

            // --- افزودن زیرنویس به پلیر ---
            function addSubtitleToPlayer(subtitleUrl) {
                // حذف زیرنویس‌های قبلی
                const existingTracks = player.media.querySelectorAll('track');
                existingTracks.forEach(track => track.remove());
                
                // ایجاد ترک جدید
                const newTrack = document.createElement('track');
                newTrack.kind = 'captions';
                newTrack.label = 'زیرنویس فارسی';
                newTrack.srclang = 'fa';
                newTrack.src = subtitleUrl;
                newTrack.default = true;
                
                player.media.appendChild(newTrack);
                
                // فعال‌سازی و نمایش زیرنویس
                setTimeout(() => {
                    player.captions.enabled = true;
                    showStatus('زیرنویس با موفقیت اضافه شد!');
                }, 100);
            }

            // --- بارگذاری فایل زیرنویس ---
            function loadSubtitleFile(file) {
                if (!file) return;
                
                if (subtitleObjectURL) {
                    URL.revokeObjectURL(subtitleObjectURL);
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const srtContent = event.target.result;
                        const vttContent = srtToVtt(srtContent);
                        const blob = new Blob([vttContent], { type: 'text/vtt' });
                        subtitleObjectURL = URL.createObjectURL(blob);
                        addSubtitleToPlayer(subtitleObjectURL);
                    } catch (error) {
                        showStatus('خطا در پردازش فایل زیرنویس: ' + error.message, false);
                    }
                };
                reader.onerror = () => showStatus('خطا در خواندن فایل زیرنویس', false);
                reader.readAsText(file, 'UTF-8');
            }

            // --- رویداد کلیک روی دکمه بارگذاری ---
            loadButton.addEventListener('click', () => {
                const videoUrl = videoUrlInput.value.trim();
                if (!videoUrl) {
                    showStatus('لطفاً لینک ویدئو را وارد کنید.', false);
                    return;
                }
                
                const subtitleFile = subtitleFileInput.files[0];
                let trackUrl = null;

                if (subtitleFile) {
                    if (subtitleObjectURL) URL.revokeObjectURL(subtitleObjectURL);
                    const srtContent = "WEBVTT"; // Placeholder
                    const blob = new Blob([srtContent], { type: 'text/vtt' });
                    trackUrl = URL.createObjectURL(blob);
                }

                // تنظیم منبع ویدئو
                player.source = {
                    type: 'video',
                    title: 'ویدئوی شما',
                    sources: [{ src: videoUrl }],
                    tracks: trackUrl ? [{
                        kind: 'captions',
                        label: 'فارسی',
                        srclang: 'fa',
                        src: trackUrl,
                        default: true
                    }] : []
                };

                // بارگذاری فایل زیرنویس واقعی پس از آماده شدن پلیر
                if (subtitleFile) {
                     player.once('canplay', () => {
                        loadSubtitleFile(subtitleFile);
                    });
                }
                
                player.play();
            });

            // --- رویداد تغییر فایل زیرنویس (در هر زمان) ---
            subtitleFileInput.addEventListener('change', (event) => {
                if (event.target.files.length > 0) {
                    const file = event.target.files[0];
                    fileNameSpan.textContent = file.name;
                    fileNameSpan.style.color = '#e0e0e0';
                    
                    // اگر پلیر در حال پخش است، زیرنویس را اضافه کن
                    if (player.playing || player.paused) {
                        loadSubtitleFile(file);
                    }
                } else {
                    fileNameSpan.textContent = 'هیچ فایلی انتخاب نشده';
                    fileNameSpan.style.color = '#a0a0a0';
                }
            });

            // --- رویدادهای مربوط به کنترل استایل زیرنویس ---
            const rootStyle = document.documentElement.style;
            fontSizeSlider.addEventListener('input', (event) => {
                const size = event.target.value;
                fontSizeValueSpan.textContent = size;
                rootStyle.setProperty('--sub-font-size', `${size}px`);
            });
            directionSelect.addEventListener('change', (event) => {
                rootStyle.setProperty('--sub-direction', event.target.value);
            });
            textColorSelect.addEventListener('change', (event) => {
                rootStyle.setProperty('--sub-text-color', event.target.value);
            });
            bgColorSelect.addEventListener('change', (event) => {
                rootStyle.setProperty('--sub-bg-color', event.target.value);
            });

            // --- کلیدهای میانبر ---
            document.addEventListener('keydown', (event) => {
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT') return;
                
                switch(event.key) {
                    case ' ': event.preventDefault(); player.togglePlay(); break;
                    case 'ArrowLeft': event.preventDefault(); player.rewind(10); break;
                    case 'ArrowRight': event.preventDefault(); player.forward(10); break;
                    case 'f': event.preventDefault(); player.fullscreen.toggle(); break;
                    case 'm': event.preventDefault(); player.muted = !player.muted; break;
                    case 'c': 
                        event.preventDefault(); 
                        player.captions.toggle();
                        break;
                }
            });
        });
    </script>

</body>
</html>